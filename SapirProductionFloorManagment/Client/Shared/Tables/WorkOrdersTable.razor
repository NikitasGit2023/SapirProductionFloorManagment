@inherits TableBase
@using SapirProductionFloorManagment.Client.Shared
@using SapirProductionFloorManagment.Client.Shared.Buttons



<div class="d-flex mb-3">
    <div class="me-auto p-2">
        <RadzenHtml Visible="IsVisible">
            <div class="d-flex flex-row-reverse">
                @if (IsCrudFrozen == false)

                {
                    <div class="p-2">
                        <div class="d-flex flex-row-reverse">
                            <div class="p-2">
                                <AddRowButton Text="Add Order" OnClick="InsertRow" Disabled="@(editMode == DataGridEditMode.Single && ordersToInsert.Count() > 0)" />
                            </div>
                        </div>
                    </div>
                }
                
            </div>
        </RadzenHtml>
    </div>
</div>


<RadzenDataGrid Visible="IsVisible" @ref="ordersGrid" AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand"
                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="true" PageSize="4"
                AllowSorting="true" Data="@orders" TItem="WorkOrderDataContext" ColumnWidth="200px"
                SelectionMode="DataGridSelectionMode.Single">
    <Columns>
         <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="SerialNumber" Title="WO" Frozen="true" Width="100px" TextAlign="TextAlign.Center">
             <EditTemplate Context="order">
                <RadzenText @bind-Value="order.SerialNumber" Style="width:100%; display: block;" />
             </EditTemplate>
         </RadzenDataGridColumn>
      
         <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="PN" Title="PN" Frozen="true" 
             Sortable="false" Filterable="false" Width="80px" TextAlign="TextAlign.Center">
             <EditTemplate Context="order">
                <RadzenText @bind-Value="order.PN" Style="width:100%; display: block;" />
            </EditTemplate>
       
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="Size" Title="Size" Frozen="IsCrudFrozen"  Width="80px">
            <EditTemplate Context="order">
                <RadzenNumeric @bind-Value="order.Size" Style="width:100%; display: block;"/>
            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="Quantity" Title="Qt" Frozen="IsCrudFrozen" Width="80px">
            <EditTemplate Context="order">
                 <RadzenNumeric @bind-Value="order.Quantity" Style="width:100%; display: block;"/>
            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="CustomerName" Frozen="IsCrudFrozen" Title="Customer Name" Width="120px">
            <EditTemplate>
                <RadzenDropDown TValue="string" Data="customers?.Select(cust => cust.Name).ToArray()" 
                                @bind-Value="order.CustomerName" Style="width:100%; display: block;" />
            </EditTemplate>
        </RadzenDataGridColumn>

       @* <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="CustomerNumber" Title="Customer No" Width="120px" />*@
       
        <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="OptionalLine" Frozen="IsCrudFrozen" Title="Line Op 1" Width="120px">
            <EditTemplate>
                <RadzenDropDown TValue="int" Data="lines?.Select(line => line.LineId).ToArray()"
                                @bind-Value="order.OptionalLine" Style="width:100%; display: block;" />
            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="OptionalLine" Frozen="IsCrudFrozen" Title="Line Op 2" Width="120px">
            <EditTemplate>
                <RadzenDropDown TValue="int" Data="lines?.Select(line => line.LineId).ToArray()"
                                @bind-Value="order.OptionalLine" Style="width:100%; display: block;" />
            </EditTemplate>
        </RadzenDataGridColumn>

     @*   <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="SalesOrderNumber" Frozen="IsCrudFrozen" Title="Sales Order ID" Width="80px" />*@

        <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="Priority" Title="Priority" Width="120px">
            <EditTemplate>
                <RadzenDropDown TValue="int" Data="lines?.Select(line => line.LineId).ToArray()"
                                @bind-Value="order.OptionalLine" Style="width:100%; display: block;" />
            </EditTemplate>
        </RadzenDataGridColumn>

        <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="WorkDuration" Frozen="IsCrudFrozen" Title="Work Duration" Width="150px" />

        <RadzenDataGridColumn TItem="WorkOrderDataContext" Property="CompletionDate" Frozen="IsCrudFrozen" Title="Completion Date" Width="150px">
           <EditTemplate>
                <RadzenDatePicker @bind-Value="order.CompletionDate"/>
           </EditTemplate>
        </RadzenDataGridColumn>

        @*crud buttons*@
        @if(IsCrudFrozen is false)
        {
            <RadzenDataGridColumn Width="100px" TItem="WorkOrderDataContext" Context="order" Filterable="false" Sortable="false"
                              TextAlign="TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                <Template Context="order">
                    <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat"
                              Size="ButtonSize.Medium" Click="@(args => EditRow(order))" @onclick:stopPropagation="true">
                    </RadzenButton>
                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat"
                              Shade="Shade.Lighter" Size="ButtonSize.Medium" class="my-1 ms-1"
                              Click="@(args => DeleteRow(order))" @onclick:stopPropagation="true">
                    </RadzenButton>
                </Template>
                <EditTemplate Context="line">
                    <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat"
                              Size="ButtonSize.Medium" Click="@((args) => SaveRow(order))">
                    </RadzenButton>
                    <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat"
                              Size="ButtonSize.Medium" class="my-1 ms-1" Click="@((args) => CancelEdit(order))">
                    </RadzenButton>
                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Variant="Variant.Flat"
                              Shade="Shade.Lighter" Size="ButtonSize.Medium" class="my-1 ms-1" Click="@(args => DeleteRow(order))">
                    </RadzenButton>
                </EditTemplate>
            </RadzenDataGridColumn>
        }
         
    </Columns>
</RadzenDataGrid>



@code 
{
    private IEnumerable<Customer>? customers;
    private IEnumerable<Line>? lines;

    public record WorkOrderDataContext()
    {
        public string SerialNumber { get; set; }
        public string PN { get; set; }
        public string Description { get; set; }
        public int Size { get; set; }
        public int Quantity { get; set; }
        public int CustomerNumber { get; set; }
        public string CustomerName { get; set; }
        public int OptionalLine { get; set; }
        public int Priority { get; set; }
        public int SalesOrderNumber { get; set; }
        public double WorkDuration { get; set; }
        public DateTime CompletionDate { get; set; }
    }

    private DataGridEditMode editMode = DataGridEditMode.Single;
    private RadzenDataGrid<WorkOrderDataContext>? ordersGrid;
    private List<WorkOrderDataContext> ordersToInsert = new List<WorkOrderDataContext>();
    private List<WorkOrderDataContext> ordersToUpdate = new List<WorkOrderDataContext>();
    private IEnumerable<WorkOrderDataContext>? orders;

    protected List<WorkOrderDataContext> fetchedOrders = new();
    protected WorkOrderDataContext order = new();
    //List<string>? hourOptions;


    protected override async Task OnInitializedAsync()
    {
        fetchedOrders.Add(new WorkOrderDataContext
        {


        });

        orders = fetchedOrders;
        customers = new List<Customer>();
        await base.OnInitializedAsync();
    }

    private void Reset()
    {
        ordersToInsert.Clear();
        ordersToUpdate.Clear();
    }

    private void Reset(WorkOrderDataContext order)
    {
        ordersToInsert.Remove(order);
        ordersToUpdate.Remove(order);
    }



    private async Task EditRow(WorkOrderDataContext order)
    {
        if (editMode == DataGridEditMode.Single && ordersToInsert.Count() > 0)
        {
            Reset();
        }

        ordersToUpdate.Add(order);
        await ordersGrid.EditRow(order);
    }

    void OnUpdateRow(WorkOrderDataContext order)
    {
        Reset(order);

        //dbCon upate

        //dbCon save
    }



    async Task SaveRow(WorkOrderDataContext order)
    {
        await ordersGrid.UpdateRow(order);
    }

    void CancelEdit(WorkOrderDataContext order)
    {
        Reset(order);

        ordersGrid.CancelEditRow(order);

        //TODO
        //var orderEntry = dbContext.Entry(order);
        //if (orderEntry.State == EntityState.Modified)
        //{
        //    orderEntry.CurrentValues.SetValues(orderEntry.OriginalValues);
        //    orderEntry.State = EntityState.Unchanged;
        //}
    }

    private async Task DeleteRow(WorkOrderDataContext order)
    {
        Reset(order);

        if (orders.Contains(order))
        {
            // dbCon remove

            //dbCon save

            await ordersGrid.Reload();
        }
        else
        {
            ordersGrid.CancelEditRow(order);
            await ordersGrid.Reload();
        }
    }

    private async Task InsertRow()
    {
        if (editMode == DataGridEditMode.Single)
        {
            Reset();
        }

        var order = new WorkOrderDataContext();
        ordersToInsert.Add(order);
        await ordersGrid.InsertRow(order);
    }


    private void OnCreateRow(WorkOrderDataContext order)
    {
        //dbCon Add
        //dbCon save
        ordersToInsert.Remove(order);
    }


}
